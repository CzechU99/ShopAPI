sudo apt update
sudo apt install gnupg2 ca-certificates

curl https://repo.k6.io/key.gpg | gpg --dearmor | sudo tee /usr/share/keyrings k6-archive-keyring.gpg >/dev/null

echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://repo.k6.io/apt stable main" | sudo tee /etc/apt/sources.list.d/k6.list

sudo apt update && sudo apt install k6
sudo snap install k6

cd /mnt/d/Desktop/ShopAPI
cd /mnt/c/Users/'Denis Czech'/Desktop/ShopAPI

export K6_PROMETHEUS_RW_SERVER_URL="http://localhost:9090/api/v1/write"
export K6_PROMETHEUS_RW_TREND_STATS="p(95),p(99),min,max"
export K6_TEST_ID="lab4-$(date +%s)"
export K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM="true"   

K6_CASE="baseline" \
k6 run -o experimental-prometheus-rw --tag testid="$K6_TEST_ID" tests/k6/lab4.js

DASHBOARD PROMETHEUS: 18030
DASHBOARD POSTGRE_EXPORTER: 9628

{container=~"external_service|shopapi-app-1"}
| json
| __error__=""


INSERT INTO users (email, full_name, hashed_password, is_active)
SELECT
    'user' || i || '@example.com' AS email,
    'User ' || i AS full_name,
    'stringst' AS hashed_password,
    TRUE AS is_active
FROM generate_series(1, 500000) AS s(i);



mkdir -p ~/k6tests
cp "/mnt/c/Users/Denis Czech/Desktop/ShopAPI/tests/k6/lab4.js" ~/k6tests/lab4.js
cd ~/k6tests

# Lab 5 helpers
docker compose --profile worker up worker

K6_SCENARIO="baseline" \
k6 run -o experimental-prometheus-rw tests/k6/lab5.js

K6_SCENARIO="async_upstream" \
K6_BROKER="kafka" \
k6 run -o experimental-prometheus-rw tests/k6/lab5.js

K6_SCENARIO="async_downstream" \
K6_BROKER="rabbitmq" \
k6 run -o experimental-prometheus-rw tests/k6/lab5.js

OPTIMUM:
HTTP1.1
MAX_CONN: 200
MAX_KEEPALIVE: 20
POOL_TIMEOUT: 1.0
EXTERNAL API DELAY: 0

